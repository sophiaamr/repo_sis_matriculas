<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/head'); %>
    <title>Formulário de Matrícula</title>
    <style>
        .navbar-nav .nav-link {
            color: white;
            font-size: 1rem;
        }

        .navbar-nav .nav-link:hover {
            color: #e9ecef;
        }

        .form-group {
            margin-bottom: 5px;
        }

        .form-group label {
            font-weight: bold;
        }

        .form-group select, 
        .form-group input[type="checkbox"] {
            margin-right: 10px;
        }

        .disciplinas-container {
            display: flex;
            flex-direction: column;
        }

        .disciplinas-container p {
            margin: 0;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .disciplinas-container input[type="checkbox"] {
            margin-right: 10px;
        }

        .error {
            color: red;
            font-size: 0.9em;
        }

        .btn-custom {
            background-color: rgb(115, 115, 141);
            border-color: rgb(115, 115, 141);
            color: #ffffff;
            width: 100%;
        }

        .btn-custom:hover {
            background-color: rgb(115, 115, 141);
            border-color: rgb(115, 115, 141);
        }
    </style>
</head>

<body class="container">
    <header>
        <%- include('partials/headerAluno'); %>
    </header>

    <main>
        <section>
            <h3>Formulário de Matrícula</h3>
            <form id="matriculaForm" action="/api/matricula" method="POST">
                <!-- Seleção do Curso -->
                <div class="form-group">
                    <label for="idCurso">Selecione o Curso:</label>
                    <select id="idCurso" name="idCurso" class="form-select" required>
                        <option value="">Selecione um curso</option>
                        <% cursos.forEach(curso => { %>
                            <option value="<%= curso.idCurso %>"><%= curso.nome %></option>
                        <% }) %>
                    </select>
                </div>

                <!-- Seleção do Período -->
                <div class="form-group">
                    <label for="periodo">Selecione o Período:</label>
                    <select id="periodo" name="periodo" class="form-select" required>
                        <!-- As opções de período serão adicionadas dinamicamente -->
                    </select>
                </div>

                 <!-- Disciplinas Obrigatórias -->
                 <div class="form-group">
                    <label>Selecione as Disciplinas Obrigatórias:</label>
                    <div class="disciplinas-container" id="disciplinasObrigatorias">
                        <!-- Disciplinas obrigatórias serão carregadas aqui -->
                    </div>
                    <div id="obrigatoriaError" class="error"></div>
                </div>

                <!-- Disciplinas Optativas -->
                <div class="form-group">
                    <label>Selecione as Disciplinas Optativas:</label>
                    <div class="disciplinas-container" id="disciplinasOptativas">
                        <!-- Disciplinas optativas serão carregadas aqui -->
                    </div>
                    <div id="optativaError" class="error"></div>
                </div>

                <button type="submit" class="btn btn-custom">Enviar</button>
            </form>
            
            <script>
                const cursos = <%- JSON.stringify(cursos) %>;
                let disciplinas = []; // Muda para let

                // Atualiza o período com base na seleção do curso
                document.getElementById('idCurso').addEventListener('change', function(event) {
                    const cursoId = event.target.value;
                    const curso = cursos.find(c => c.idCurso == cursoId);

                    let selectPeriodo = document.getElementById('periodo');

                    selectPeriodo.innerHTML = '<option value="">Selecione o período</option>';

                    if (curso) {
                        for (let index = 1; index <= curso.periodo; index++) {
                           selectPeriodo.innerHTML += `<option value="${index}">Período ${index}</option>`;
                        }
                    }
                });

                // Função para carregar e atualizar as disciplinas
                function carregarDisciplinas() {
                    const cursoId = document.getElementById('idCurso').value;
                    const periodoSelecionado = document.getElementById('periodo').value;

                    if (!cursoId || !periodoSelecionado) return;

                    fetch(`/api/disciplinas?cursoId=${cursoId}&periodo=${periodoSelecionado}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erro na resposta da API');
                            }
                            return response.json();
                        })
                        .then(data => {
                            disciplinas = data;
                            const disciplinasObrigatorias = document.getElementById('disciplinasObrigatorias');
                            const disciplinasOptativas = document.getElementById('disciplinasOptativas');

                            disciplinasObrigatorias.innerHTML = '';
                            disciplinasOptativas.innerHTML = '';

                            disciplinas.forEach(disciplina => {
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.value = disciplina.idDisciplina;

                                const label = document.createElement('label');
                                label.textContent = disciplina.nome;

                                const container = document.createElement('p');
                                container.appendChild(checkbox);
                                container.appendChild(label);

                              
                            });
                        })
                        .catch(error => {
                            console.error('Erro ao carregar disciplinas:', error);
                            document.getElementById('obrigatoriaError').textContent = 'Erro ao carregar disciplinas.';
                        });
                }

                document.getElementById('periodo').addEventListener('change', carregarDisciplinas);
            
            </script>
        </section>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    </main>
</body>
</html>
