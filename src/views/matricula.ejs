<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/head'); %>
    <title>Formulário de Matrícula</title>
    <style>
        .navbar-nav .nav-link {
            color: white;
            font-size: 1rem;
        }

        .navbar-nav .nav-link:hover {
            color: #e9ecef;
        }

        .form-group {
            margin-bottom: 5px;
        }

        .form-group label {
            font-weight: bold;
        }

        .form-group select, 
        .form-group input[type="checkbox"] {
            margin-right: 10px;
        }

        .disciplinas-container {
            display: flex;
            flex-direction: column;
        }

        .disciplinas-container p {
            margin: 0;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .disciplinas-container input[type="checkbox"] {
            margin-right: 10px;
        }

        .error {
            color: red;
            font-size: 0.9em;
        }

        .btn-custom {
            background-color: rgb(115, 115, 141);
            border-color:  rgb(115, 115, 141);
            color: #ffffff;
            width: 100%;
        }

        .btn-custom:hover {
            background-color: rgb(115, 115, 141);
            border-color:  rgb(115, 115, 141);
        }
    </style>
</head>


<body class="container">
    <header>
        <%- include('partials/headerAluno'); %>
    </header>

    <main>
        <section>
            <h3>Formulário de Matrícula</h3>
            <form id="matriculaForm" action="/api/matricula" method="POST">
                <!-- Seleção do Curso -->
                <div class="form-group">
                    <label for="idCurso">Selecione o Curso:</label>
                    <select id="idCurso" name="idCurso" class="form-select" required>
                        <option value="">Selecione um curso</option>
                        <% cursos.forEach(curso => { %>
                            <option value="<%= curso.idCurso %>"><%= curso.nome %></option>
                        <% }) %>
                    </select>
                </div>

                <!-- Seleção do Período -->
                <div class="form-group">
                    <label for="periodo">Selecione o Período:</label>
                    <select id="periodo" name="periodo" class="form-select" required>
                        <option value="">Selecione o período</option>
                        <% for (let i = 1; i <= 12; i++) { %>
                            <option value="<%= i %>">Período <%= i %></option>
                        <% } %>
                    </select>
                </div>

                <!-- Disciplinas Obrigatórias -->
                <div class="form-group">
                    <label>Selecione as Disciplinas Obrigatórias:</label>
                    <div class="disciplinas-container" id="disciplinasObrigatorias">
                        <!-- Disciplinas obrigatórias serão carregadas aqui -->
                    </div>
                    <div id="obrigatoriaError" class="error"></div>
                </div>

                <!-- Disciplinas Optativas -->
                <div class="form-group">
                    <label>Selecione as Disciplinas Optativas:</label>
                    <div class="disciplinas-container" id="disciplinasOptativas">
                        <!-- Disciplinas optativas serão carregadas aqui -->
                    </div>
                    <div id="optativaError" class="error"></div>
                </div>

                <button type="submit" class="btn btn-custom">Enviar</button>
            </form>
            
            <script>
                // Atualiza a lista de disciplinas quando um período é selecionado
                document.getElementById('periodo').addEventListener('change', function() {
                    const cursoId = document.getElementById('idCurso').value;
                    const periodo = parseInt(this.value, 10);

                    if (cursoId && periodo) {
                        fetch(`/api/disciplinas?cursoId=${cursoId}&periodo=${periodo}`)
                            .then(response => response.json())
                            .then(data => {
                                const obrigatoriasContainer = document.getElementById('disciplinasObrigatorias');
                                const optativasContainer = document.getElementById('disciplinasOptativas');

                                obrigatoriasContainer.innerHTML = '';
                                optativasContainer.innerHTML = '';

                                data.forEach(disciplina => {
                                    const container = disciplina.numCredito === 2 ? obrigatoriasContainer : optativasContainer;
                                    const p = document.createElement('p');
                                    const checkbox = document.createElement('input');
                                    checkbox.type = 'checkbox';
                                    checkbox.name = disciplina.numCredito === 2 ? 'disciplinasObrigatorias' : 'disciplinasOptativas';
                                    checkbox.value = disciplina.idDisciplina;
                                    checkbox.id = `disciplina-${disciplina.idDisciplina}`;

                                    const label = document.createElement('label');
                                    label.htmlFor = checkbox.id;
                                    label.textContent = disciplina.nomeDisciplina;

                                    p.appendChild(checkbox);
                                    p.appendChild(label);
                                    container.appendChild(p);
                                });
                            })
                            .catch(error => console.error('Erro ao carregar disciplinas:', error));
                    } else {
                        // Limpar disciplinas se nenhum curso ou período estiver selecionado
                        document.getElementById('disciplinasObrigatorias').innerHTML = '';
                        document.getElementById('disciplinasOptativas').innerHTML = '';
                    }
                });

                // Valida a seleção de disciplinas
                document.getElementById('matriculaForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    let obrigatoriasChecked = document.querySelectorAll('input[name="disciplinasObrigatorias"]:checked').length;
                    let optativasChecked = document.querySelectorAll('input[name="disciplinasOptativas"]:checked').length;
                    let obrigatoriaError = document.getElementById('obrigatoriaError');
                    let optativaError = document.getElementById('optativaError');

                    obrigatoriaError.textContent = '';
                    optativaError.textContent = '';

                    if (obrigatoriasChecked !== 4) {
                        obrigatoriaError.textContent = 'Você deve selecionar exatamente 4 disciplinas obrigatórias.';
                    }

                    if (optativasChecked !== 2) {
                        optativaError.textContent = 'Você deve selecionar exatamente 2 disciplinas optativas.';
                    }

                    if (obrigatoriasChecked === 4 && optativasChecked === 2) {
                        this.submit(); 
                    }
                });
            </script>
        </section>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    </main>
</body>
</html>